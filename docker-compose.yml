# Use YAML anchors to define build configurations once.
# This prevents rebuilding the same image for multiple services.
x-ml-build: &ml-build
  context: .
  dockerfile: ./ml/Dockerfile

x-backend-build: &backend-build
  context: .
  dockerfile: ./backend/Dockerfile

services:
  mongodb:
    # Best practice: Pin to a specific version instead of 'latest'.
    image: mongo:7
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test:
        ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 10s
      timeout: 5s
      retries: 10

  mlflow:
    # Reuse the ML build definition defined by the anchor.
    build: *ml-build
    container_name: mlflow
    restart: always
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_SERVER_ALLOWED_HOSTS=mlflow,localhost,127.0.0.1,*
      - MONGO_URI=mongodb://root:example@mongodb:27017/?authSource=admin
      - DB_NAME=digikala
      - PRODUCTS_COLLECTION=products
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MODEL_NAME=${MODEL_NAME:-Linkage}
      - MODEL_VERSION=${MODEL_VERSION:-2}
    volumes:
      # Mount to the paths defined in the Dockerfile's VOLUME instruction.
      - ./mlruns:/app/mlruns:rw
      - ./mlartifacts:/app/mlartifacts:rw
    user: "${UID}:${GID}"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import sys,urllib.request as u; r=u.urlopen('http://127.0.0.1:5000/health'); sys.exit(0 if r.getcode()==200 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    depends_on:
      mongodb:
        condition: service_healthy

  backend:
    # Reuse the backend build definition.
    build: *backend-build
    container_name: backend
    restart: on-failure
    environment:
      - MONGO_URI=mongodb://root:example@mongodb:27017/?authSource=admin
      - DB_NAME=digikala
      - PRODUCTS_COLLECTION=products
      - USERS_COLLECTION=users
      - SECRET_KEY=${SECRET_KEY:-change-me-to-a-secure-secret-key-in-production}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
    ports:
      - "8000:8000"
    user: "${UID}:${GID}"
    depends_on:
      mongodb:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-8080}:80"
    depends_on:
      backend:
        condition: service_started

  data-pipeline:
    build:
      context: .
      dockerfile: ./data/Dockerfile
    container_name: data-pipeline
    restart: unless-stopped
    environment:
      - RUN_MODE=scheduler
      - PIPELINE_INTERVAL_DAYS=${PIPELINE_INTERVAL_DAYS:-3}
      - PIPELINE_INITIAL_DELAY_SECONDS=${PIPELINE_INITIAL_DELAY_SECONDS:-0}
      - PIPELINE_EXTRACT=${PIPELINE_EXTRACT:-true}
      - MONGO_URI=mongodb://root:example@mongodb:27017/?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - data_original_data:/app/data/digikala/original_data:rw
      - data_logs:/app/data/digikala/logs:rw

volumes:
  mongodb_data:
  data_original_data:
  data_logs:
