# Use YAML anchors to define build configurations once.
# This prevents rebuilding the same image for multiple services.
x-ml-build: &ml-build
  context: .
  dockerfile: ./ml/Dockerfile

x-backend-build: &backend-build
  context: .
  dockerfile: ./back-end/Dockerfile

services:
  mongodb:
    # Best practice: Pin to a specific version instead of 'latest'.
    image: mongo:latest
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test:
        ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 10s
      timeout: 5s
      retries: 10

  mlflow:
    # Reuse the ML build definition defined by the anchor.
    build: *ml-build
    container_name: mlflow
    restart: always
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_SERVER_ALLOWED_HOSTS=mlflow,localhost,127.0.0.1,*
      - MONGO_URI=mongodb://root:example@mongodb:27017/?authSource=admin
      - DB_NAME=digikala
      - PRODUCTS_COLLECTION=products
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MODEL_NAME=${MODEL_NAME:-Linkage}
      - MODEL_VERSION=${MODEL_VERSION:-2}
    volumes:
      # Mount to the paths defined in the Dockerfile's VOLUME instruction.
      - ./mlruns:/app/mlruns:rw
      - ./mlartifacts:/app/mlartifacts:rw
    user: "${UID}:${GID}"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import sys,urllib.request as u; r=u.urlopen('http://127.0.0.1:5000/health'); sys.exit(0 if r.getcode()==200 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    depends_on:
      mongodb:
        condition: service_healthy

  backend:
    # Reuse the backend build definition.
    build: *backend-build
    container_name: backend
    restart: on-failure
    environment:
      - MONGO_URI=mongodb://root:example@mongodb:27017/?authSource=admin
      - DB_NAME=digikala
      - PRODUCTS_COLLECTION=products
    ports:
      - "8000:8000"
    depends_on:
      mongodb:
        condition: service_healthy

volumes:
  mongodb_data:
  data_original_data:
  data_logs:
